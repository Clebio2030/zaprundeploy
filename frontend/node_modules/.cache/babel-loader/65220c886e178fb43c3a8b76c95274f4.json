{"ast":null,"code":"import React,{useContext,useState}from\"react\";import{Chip,IconButton,List,ListItem,ListItemSecondaryAction,ListItemText,makeStyles}from\"@material-ui/core\";import{useHistory,useParams}from\"react-router-dom\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{useDate}from\"../../hooks/useDate\";import DeleteIcon from\"@material-ui/icons/Delete\";import EditIcon from\"@material-ui/icons/Edit\";import ConfirmationModal from\"../../components/ConfirmationModal\";import api from\"../../services/api\";const useStyles=makeStyles(theme=>({mainContainer:{display:\"flex\",flexDirection:\"column\",position:\"relative\",flex:1,height:\"calc(100% - 58px)\",overflow:\"hidden\",borderRadius:0,backgroundColor:theme.mode==='light'?\"#f2f2f2\":\"#7f7f7f\"},chatList:{display:\"flex\",flexDirection:\"column\",position:\"relative\",flex:1,overflowY:\"scroll\",...theme.scrollbarStyles},listItemActive:{cursor:\"pointer\",backgroundColor:theme.palette.background.paper,borderLeft:\"6px solid #002d6e\"},listItem:{cursor:\"pointer\",backgroundColor:theme.palette.background.color}}));export default function ChatList(_ref){let{chats,handleSelectChat,handleDeleteChat,handleEditChat,pageInfo,loading}=_ref;const classes=useStyles();const history=useHistory();const{user,socket}=useContext(AuthContext);const{datetimeToClient}=useDate();const[confirmationModal,setConfirmModalOpen]=useState(false);const[selectedChat,setSelectedChat]=useState({});const{id}=useParams();const goToMessages=async chat=>{try{if(unreadMessages(chat)>0){try{await api.post(\"/chats/\".concat(chat.id,\"/read\"),{userId:user.id});}catch(err){console.error(\"Erro ao marcar mensagens como lidas:\",err);}}// Primeiro selecionar o chat na interface local\nhandleSelectChat(chat);// Depois redirecionar, se o ID atual for diferente\nif(id!==chat.uuid){setTimeout(()=>{history.push(\"/chats/\".concat(chat.uuid));},50);}}catch(err){console.error(\"Erro ao navegar para mensagens:\",err);}};const handleDelete=()=>{handleDeleteChat(selectedChat);};const unreadMessages=chat=>{const currentUser=chat.users.find(u=>u.userId===user.id);return currentUser.unreads;};const getPrimaryText=chat=>{const mainText=chat.title;const unreads=unreadMessages(chat);return/*#__PURE__*/React.createElement(React.Fragment,null,mainText,unreads>0&&/*#__PURE__*/React.createElement(Chip,{size:\"small\",style:{marginLeft:5},label:unreads,color:\"secondary\"}));};const getSecondaryText=chat=>{return chat.lastMessage!==\"\"?\"\".concat(datetimeToClient(chat.updatedAt),\": \").concat(chat.lastMessage):\"\";};return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(ConfirmationModal,{title:\"Excluir Conversa\",open:confirmationModal,onClose:setConfirmModalOpen,onConfirm:handleDelete},\"Esta a\\xE7\\xE3o n\\xE3o pode ser revertida, confirmar?\"),/*#__PURE__*/React.createElement(\"div\",{className:classes.mainContainer},/*#__PURE__*/React.createElement(\"div\",{className:classes.chatList},/*#__PURE__*/React.createElement(List,null,Array.isArray(chats)&&chats.length>0&&chats.map((chat,key)=>/*#__PURE__*/React.createElement(ListItem,{onClick:()=>goToMessages(chat),key:key,className:chat.uuid===id?classes.listItemActive:classes.listItem,button:true},/*#__PURE__*/React.createElement(ListItemText,{primary:getPrimaryText(chat),secondary:getSecondaryText(chat)}),chat.ownerId===user.id&&/*#__PURE__*/React.createElement(ListItemSecondaryAction,null,/*#__PURE__*/React.createElement(IconButton,{onClick:e=>{e.stopPropagation();// Evitar conflito com o clique no ListItem\n// Verificar se os usuários têm a estrutura esperada\nconst hasUsers=Array.isArray(chat.users)&&chat.users.length>0;if(!hasUsers){console.error(\"Sem usuários no chat:\",chat);alert(\"Não foi possível editar o chat. Tente recarregar a página.\");return;}console.log(\"Estrutura de usuários:\",chat.users);// Verifica se conseguimos extrair os dados necessários dos usuários\n// Tenta diferentes formatos possíveis\ntry{const userList=chat.users.map(u=>{// Formato 1: { user: { id, name } }\nif(u&&u.user&&u.user.id&&u.user.name){return{id:u.user.id,name:u.user.name};}// Formato 2: { userId, user: { name } }\nif(u&&u.userId&&u.user&&u.user.name){return{id:u.userId,name:u.user.name};}// Formato 3: { id, name } diretamente\nif(u&&u.id&&u.name){return{id:u.id,name:u.name};}// Se chegou aqui, não conseguiu extrair os dados\nconsole.error(\"Formato de usuário não reconhecido:\",u);throw new Error(\"Formato de usuário não reconhecido\");});// Primeiro, seleciona o chat antes de abrir o modal de edição\nhandleSelectChat(chat);// Adicionar um pequeno atraso para garantir que o chat foi selecionado\nsetTimeout(()=>{// Chama a função de edição passando o chat completo\nhandleEditChat(chat);},100);}catch(err){console.error(\"Erro ao processar usuários:\",err);alert(\"Formato de usuários não reconhecido. Tente recarregar a página.\");}},edge:\"end\",\"aria-label\":\"edit\",size:\"small\",style:{marginRight:5}},/*#__PURE__*/React.createElement(EditIcon,null)),/*#__PURE__*/React.createElement(IconButton,{onClick:e=>{e.stopPropagation();// Evitar conflito com o clique no ListItem\nsetSelectedChat(chat);setConfirmModalOpen(true);},edge:\"end\",\"aria-label\":\"delete\",size:\"small\"},/*#__PURE__*/React.createElement(DeleteIcon,null)))))))));}","map":null,"metadata":{},"sourceType":"module"}