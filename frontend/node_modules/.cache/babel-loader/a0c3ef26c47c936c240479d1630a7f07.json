{"ast":null,"code":"import React,{useState,useRef,useEffect}from\"react\";import{makeStyles}from\"@material-ui/core/styles\";import{Box,Typography,IconButton,Tooltip,Dialog,DialogContent,Link}from\"@material-ui/core\";import GetAppIcon from\"@material-ui/icons/GetApp\";import CloseIcon from\"@material-ui/icons/Close\";import ImageIcon from\"@material-ui/icons/Image\";import PictureAsPdfIcon from\"@material-ui/icons/PictureAsPdf\";import DescriptionIcon from\"@material-ui/icons/Description\";import MovieIcon from\"@material-ui/icons/Movie\";import InsertDriveFileIcon from\"@material-ui/icons/InsertDriveFile\";import VisibilityIcon from\"@material-ui/icons/Visibility\";import PlayCircleOutlineIcon from'@material-ui/icons/PlayCircleOutline';import PauseCircleOutlineIcon from'@material-ui/icons/PauseCircleOutline';import AudiotrackIcon from'@material-ui/icons/Audiotrack';import ChatAudioPlayer from\"./ChatAudioPlayer\";const useStyles=makeStyles(theme=>({fileContainer:{display:\"flex\",flexDirection:\"column\",gap:8,marginTop:8,marginBottom:8,maxWidth:280},fileItem:{display:\"flex\",alignItems:\"center\",padding:6,borderRadius:4,backgroundColor:theme.palette.background.default,border:\"1px solid rgba(0, 0, 0, 0.12)\",width:\"100%\"},fileIcon:{marginRight:8,fontSize:24},fileDetails:{flex:1,overflow:\"hidden\"},fileName:{fontSize:12,fontWeight:500,textOverflow:\"ellipsis\",overflow:\"hidden\",whiteSpace:\"nowrap\"},fileSize:{fontSize:10,color:theme.palette.text.secondary},fileActions:{display:\"flex\",gap:4},actionButton:{padding:4},previewImage:{maxWidth:\"100%\",maxHeight:\"80vh\",objectFit:\"contain\"},previewVideo:{maxWidth:\"100%\",maxHeight:\"80vh\"},previewPdf:{width:\"100%\",height:\"80vh\"},previewDialog:{\"& .MuiDialog-paper\":{position:\"relative\"}},closeButton:{position:\"absolute\",right:8,top:8,color:theme.palette.grey[500],zIndex:2,backgroundColor:\"rgba(255,255,255,0.7)\",\"&:hover\":{backgroundColor:\"rgba(255,255,255,0.9)\"}},thumbnailImage:{width:40,height:40,objectFit:\"cover\",borderRadius:4,marginRight:8},audioPlayButton:{padding:4}}));// Função para formatar o tamanho do arquivo em KB ou MB\nconst formatFileSize=bytes=>{if(!bytes)return\"0 B\";if(bytes<1024){return bytes+\" B\";}else if(bytes<1024*1024){return(bytes/1024).toFixed(1)+\" KB\";}else{return(bytes/(1024*1024)).toFixed(1)+\" MB\";}};// Função para obter o ícone correto de acordo com o tipo de arquivo\nconst getFileIcon=fileName=>{if(!fileName)return/*#__PURE__*/React.createElement(InsertDriveFileIcon,null);const extension=fileName.split('.').pop().toLowerCase();if(['jpg','jpeg','png','gif'].includes(extension)){return/*#__PURE__*/React.createElement(ImageIcon,{color:\"primary\"});}else if(extension==='pdf'){return/*#__PURE__*/React.createElement(PictureAsPdfIcon,{color:\"error\"});}else if(['doc','docx'].includes(extension)){return/*#__PURE__*/React.createElement(DescriptionIcon,{color:\"primary\"});}else if(['mp4','avi','mov'].includes(extension)){return/*#__PURE__*/React.createElement(MovieIcon,{color:\"secondary\"});}else if(['mp3','wav','ogg','opus'].includes(extension)){return/*#__PURE__*/React.createElement(AudiotrackIcon,{color:\"primary\"});}else{return/*#__PURE__*/React.createElement(InsertDriveFileIcon,{color:\"action\"});}};// Função para verificar se o arquivo é visualizável\nconst isPreviewable=fileName=>{if(!fileName)return false;const extension=fileName.split('.').pop().toLowerCase();return['jpg','jpeg','png','gif','pdf','mp4','mp3','wav','ogg','opus'].includes(extension);};// Função para verificar se o arquivo é de áudio\nconst isAudioFile=fileName=>{if(!fileName)return false;const extension=fileName.split('.').pop().toLowerCase();return['mp3','wav','ogg','opus'].includes(extension);};// Função para obter a URL completa do arquivo\nconst getFullUrl=url=>{if(!url)return\"\";// Se a URL já começa com http ou https, retornar como está\nif(url.startsWith('http://')||url.startsWith('https://')){return url;}// Se a URL é relativa, adicionar o endereço do backend\nconst BACKEND_URL=process.env.REACT_APP_BACKEND_URL||window.location.origin;// Se começa com '/', removemos a barra para evitar duplicação\nconst cleanUrl=url.startsWith('/')?url.substring(1):url;// Verificar se já contém o prefixo public/ antes de adicioná-lo\nconst urlWithPublic=cleanUrl.startsWith('public/')?cleanUrl:\"public/\".concat(cleanUrl);const fullUrl=\"\".concat(BACKEND_URL,\"/\").concat(urlWithPublic);console.log('[DEBUG URL]',{original:url,final:fullUrl});return fullUrl;};export default function ChatFileMessage(_ref){let{files,isRight}=_ref;const classes=useStyles();const[previewOpen,setPreviewOpen]=useState(false);const[selectedFile,setSelectedFile]=useState(null);const[isAudioPlaying,setIsAudioPlaying]=useState(false);const audioRef=useRef(null);const[audioDurations,setAudioDurations]=useState({});useEffect(()=>{if(audioRef.current){audioRef.current.onended=()=>{setIsAudioPlaying(false);};}if(files&&files.length>0){const processAudioFiles=async()=>{const durations={...audioDurations};for(const file of files){var _file$name;const fileExt=(_file$name=file.name)===null||_file$name===void 0?void 0:_file$name.split('.').pop().toLowerCase();const isAudio=['mp3','wav','ogg','opus'].includes(fileExt);if(isAudio){// Primeiro verificamos se já temos a duração no estado para este arquivo\nif(audioDurations[file.id]&&audioDurations[file.id]>0){console.log(\"[DEBUG] J\\xE1 temos dura\\xE7\\xE3o em cache para \".concat(file.name,\": \").concat(audioDurations[file.id],\"s\"));continue;}// Próxima fonte: arquivo tem metadados com duração válida\nif(file.metadata&&file.metadata.duration&&!isNaN(file.metadata.duration)&&isFinite(file.metadata.duration)&&file.metadata.duration>0){durations[file.id]=file.metadata.duration;console.log(\"[DEBUG] Dura\\xE7\\xE3o obtida dos metadados: \".concat(file.metadata.duration,\"s para \").concat(file.name));continue;}// Próxima fonte: arquivo tem propriedade duration direta\nif(file.duration&&!isNaN(file.duration)&&isFinite(file.duration)&&file.duration>0){durations[file.id]=file.duration;console.log(\"[DEBUG] Dura\\xE7\\xE3o obtida da propriedade file.duration: \".concat(file.duration,\"s para \").concat(file.name));continue;}// Se não temos duração ainda, tentar carregar o áudio\ntry{// Obter URL completa do arquivo\nconst fileUrl=getFullUrl(file.url);console.log(\"[DEBUG] Tentando obter dura\\xE7\\xE3o para \".concat(file.name,\" de \").concat(fileUrl));// Criar um elemento de áudio para tentar carregar os metadados\nconst audio=new Audio();// Usar Promise.race para limitar o tempo de espera\nconst result=await Promise.race([// Promise para carregar os metadados\nnew Promise(resolve=>{// Quando os metadados estiverem carregados\nconst onLoadedMetadata=()=>{if(!isNaN(audio.duration)&&isFinite(audio.duration)&&audio.duration>0){console.log(\"[DEBUG] Dura\\xE7\\xE3o carregada do arquivo: \".concat(audio.duration,\"s para \").concat(file.name));resolve({success:true,duration:audio.duration});}else{console.warn(\"[WARN] Dura\\xE7\\xE3o inv\\xE1lida para \".concat(file.name,\": \").concat(audio.duration));resolve({success:false});}};// Quando o áudio estiver pronto para tocar\nconst onCanPlayThrough=()=>{if(!isNaN(audio.duration)&&isFinite(audio.duration)&&audio.duration>0){console.log(\"[DEBUG] Dura\\xE7\\xE3o obtida em canplaythrough: \".concat(audio.duration,\"s para \").concat(file.name));resolve({success:true,duration:audio.duration});}};// Quando ocorrer um erro no carregamento\nconst onError=e=>{console.error(\"[ERROR] Erro ao carregar \\xE1udio \".concat(file.name,\":\"),e);resolve({success:false});};// Configurar os event listeners\naudio.addEventListener('loadedmetadata',onLoadedMetadata);audio.addEventListener('canplaythrough',onCanPlayThrough);audio.addEventListener('error',onError);// Configurar para carregar apenas os metadados e iniciar o carregamento\naudio.preload='metadata';audio.src=fileUrl;audio.load();}),// Promise de timeout para limitar o tempo de espera\nnew Promise(resolve=>{setTimeout(()=>{console.warn(\"[WARN] Timeout ao carregar metadados para \".concat(file.name));resolve({success:false,timeout:true});},5000);// 5 segundos de timeout\n})]);// Processar o resultado\nif(result.success&&result.duration){durations[file.id]=result.duration;}else{// Falha no carregamento, usar duração padrão de 30 segundos para não ficar sem nada\nconsole.warn(\"[WARN] Usando dura\\xE7\\xE3o padr\\xE3o (30s) para \".concat(file.name));durations[file.id]=30;// 30 segundos como fallback razoável\n}}catch(error){console.error(\"[ERROR] Exce\\xE7\\xE3o ao processar \\xE1udio \".concat(file.name,\":\"),error);// Usar duração padrão em caso de erro\ndurations[file.id]=30;}}}// Atualizar o estado com todas as durações processadas\nif(Object.keys(durations).length>0){console.log('[DEBUG] Atualizando estado de durações:',durations);setAudioDurations(durations);}};// Executar o processamento de áudios\nprocessAudioFiles();}},[files,audioDurations]);if(!files||files.length===0)return null;const handlePreview=file=>{setSelectedFile(file);setPreviewOpen(true);};const handleClosePreview=()=>{setPreviewOpen(false);setIsAudioPlaying(false);if(audioRef.current){audioRef.current.pause();}};const toggleAudioPlayback=(file,event)=>{event.stopPropagation();if(!audioRef.current)return;if(isAudioPlaying){audioRef.current.pause();}else{audioRef.current.src=getFullUrl(file.url);audioRef.current.play();}setIsAudioPlaying(!isAudioPlaying);};const renderPreview=()=>{var _selectedFile$name;if(!selectedFile)return null;const fileExt=(_selectedFile$name=selectedFile.name)===null||_selectedFile$name===void 0?void 0:_selectedFile$name.split('.').pop().toLowerCase();const fileUrl=getFullUrl(selectedFile.url);if(['jpg','jpeg','png','gif'].includes(fileExt)){return/*#__PURE__*/React.createElement(\"img\",{src:fileUrl,alt:selectedFile.name,style:{maxWidth:'100%',maxHeight:'calc(80vh - 64px)'},onError:e=>{console.error('Erro ao carregar imagem:',fileUrl);e.target.onerror=null;e.target.src=\"\".concat(process.env.PUBLIC_URL,\"/nopicture.png\");}});}else if(fileExt==='pdf'){return/*#__PURE__*/React.createElement(\"iframe\",{src:\"\".concat(fileUrl,\"#view=FitH\"),title:selectedFile.name,width:\"100%\",height:\"80vh\",style:{border:'none'}});}else if(['mp4','avi','mov'].includes(fileExt)){return/*#__PURE__*/React.createElement(\"video\",{src:fileUrl,controls:true,autoPlay:true,style:{maxWidth:'100%',maxHeight:'calc(80vh - 64px)'}});}else if(['mp3','wav','ogg','opus'].includes(fileExt)){return/*#__PURE__*/React.createElement(\"div\",{style:{width:'100%',padding:'20px',textAlign:'center'}},/*#__PURE__*/React.createElement(AudiotrackIcon,{style:{fontSize:60,color:'#3f51b5',marginBottom:20}}),/*#__PURE__*/React.createElement(Typography,{variant:\"h6\",style:{marginBottom:20}},selectedFile.name),/*#__PURE__*/React.createElement(\"audio\",{ref:audioRef,src:fileUrl,controls:true,style:{width:'100%'},onError:e=>{console.error('Erro ao carregar áudio:',fileUrl,e);if(fileUrl.includes('/public/')){const BACKEND_URL=process.env.REACT_APP_BACKEND_URL||window.location.origin;const originalUrl=selectedFile.url;const alternativeUrl=\"\".concat(BACKEND_URL,\"/\").concat(originalUrl.startsWith('/')?originalUrl.substring(1):originalUrl);console.log('Tentando URL alternativa para o áudio:',alternativeUrl);e.target.src=alternativeUrl;e.target.load();}}}));}else{return/*#__PURE__*/React.createElement(Typography,{variant:\"body1\",style:{padding:20,textAlign:'center'}},\"Este tipo de arquivo n\\xE3o pode ser visualizado diretamente.\",/*#__PURE__*/React.createElement(\"br\",null),/*#__PURE__*/React.createElement(Link,{href:fileUrl,target:\"_blank\",download:true},\"Clique aqui para baixar\"));}};const renderFileItems=()=>{return files.map((file,index)=>{var _file$name2;const fileExt=(_file$name2=file.name)===null||_file$name2===void 0?void 0:_file$name2.split('.').pop().toLowerCase();const isAudio=['mp3','wav','ogg','opus'].includes(fileExt);if(isAudio){// Obter a duração do estado ou usar valor padrão\nlet audioDuration=audioDurations[file.id]||0;// Logs para depuração\nconsole.log(\"[DEBUG] Renderizando \\xE1udio \".concat(file.name,\" com dura\\xE7\\xE3o \").concat(audioDuration,\"s\"));return/*#__PURE__*/React.createElement(Box,{key:index,className:classes.fileItem,style:{padding:0}},/*#__PURE__*/React.createElement(ChatAudioPlayer,{audioUrl:file.url,duration:audioDuration,isRight:isRight}));}return/*#__PURE__*/React.createElement(Box,{key:index,className:classes.fileItem},['jpg','jpeg','png','gif'].includes(fileExt)?/*#__PURE__*/React.createElement(\"img\",{src:getFullUrl(file.url),alt:file.name,className:classes.thumbnailImage,onError:e=>{e.target.onerror=null;e.target.src=\"\".concat(process.env.PUBLIC_URL,\"/nopicture.png\");}}):getFileIcon(file.name),/*#__PURE__*/React.createElement(Box,{className:classes.fileDetails},/*#__PURE__*/React.createElement(Typography,{className:classes.fileName},file.name),/*#__PURE__*/React.createElement(Typography,{className:classes.fileSize},formatFileSize(file.size))),/*#__PURE__*/React.createElement(Box,{className:classes.fileActions},isPreviewable(file.name)&&/*#__PURE__*/React.createElement(Tooltip,{title:\"Visualizar\"},/*#__PURE__*/React.createElement(IconButton,{className:classes.actionButton,onClick:()=>handlePreview(file)},/*#__PURE__*/React.createElement(VisibilityIcon,{fontSize:\"small\"}))),/*#__PURE__*/React.createElement(Tooltip,{title:\"Baixar\"},/*#__PURE__*/React.createElement(IconButton,{className:classes.actionButton,component:Link,href:getFullUrl(file.url),download:file.name,target:\"_blank\"},/*#__PURE__*/React.createElement(GetAppIcon,{fontSize:\"small\"})))));});};return/*#__PURE__*/React.createElement(Box,{className:classes.fileContainer},renderFileItems(),/*#__PURE__*/React.createElement(Dialog,{open:previewOpen,onClose:handleClosePreview,maxWidth:\"lg\",className:classes.previewDialog},/*#__PURE__*/React.createElement(IconButton,{className:classes.closeButton,onClick:handleClosePreview},/*#__PURE__*/React.createElement(CloseIcon,null)),/*#__PURE__*/React.createElement(DialogContent,{style:{padding:16}},renderPreview()),/*#__PURE__*/React.createElement(\"audio\",{ref:audioRef,style:{display:'none'}})));}","map":null,"metadata":{},"sourceType":"module"}